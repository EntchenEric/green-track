<mvc:View controllerName="greentrack.controller.Dashboard"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:f="sap.f"
    xmlns:card="sap.f.cards"
    xmlns:core="sap.ui.core"
    xmlns:mc="sap.suite.ui.microchart"
    xmlns:layout="sap.ui.layout"
    displayBlock="true">

    <f:DynamicPage id="dynamicPage" headerExpanded="true" toggleHeaderOnTitleClick="true" backgroundDesign="Solid">
        
        <f:title>
            <f:DynamicPageTitle>
                <f:heading>
                    <Title text="GreenTrack Executive Hub" level="H2"/>
                </f:heading>
                <f:expandedContent>
                    <Label text="Dashboard Übersicht" />
                </f:expandedContent>
                <f:snappedContent>
                    <Label text="Dashboard" />
                </f:snappedContent>
                <f:content>
                    <Button icon="sap-icon://refresh" text="Aktualisieren" press="onRefresh" type="Transparent"/>
                </f:content>
            </f:DynamicPageTitle>
        </f:title>

        <f:header>
            <f:DynamicPageHeader pinnable="true">
                <layout:HorizontalLayout allowWrapping="true">
                    <layout:VerticalLayout class="sapUiLargeMarginEnd">
                        <ObjectAttribute title="Offene Aufträge" text="{dashboard>/stats/openOrders}"/>
                        <ObjectStatus text="Handlungsbedarf" state="{dashboard>/stats/openOrdersState}" icon="sap-icon://alert"/>
                    </layout:VerticalLayout>

                    <layout:VerticalLayout class="sapUiLargeMarginEnd">
                        <ObjectAttribute title="Routen Heute" text="{dashboard>/stats/todaysRoutes}"/>
                        <ObjectStatus text="Im Plan" state="Success" icon="sap-icon://shipping-status"/>
                    </layout:VerticalLayout>

                    <layout:VerticalLayout>
                        <ObjectAttribute title="CO₂ Reduktion" text="{dashboard>/stats/co2Saved} kg"/>
                        <ProgressIndicator percentValue="{dashboard>/stats/co2Target}" displayValue="{dashboard>/stats/co2Target}% Ziel" state="Success" width="140px"/>
                    </layout:VerticalLayout>
                </layout:HorizontalLayout>
            </f:DynamicPageHeader>
        </f:header>

        <f:content>
            <VBox class="sapUiMediumMargin">
                
                <f:GridContainer id="dashboardGrid" snapToRow="true" class="sapUiMediumMarginBottom">
                    <f:layout>
                        <f:GridContainerSettings rowSize="80px" columnSize="80px" gap="1rem" />
                    </f:layout>

                    <f:Card>
                        <f:layoutData>
                            <f:GridContainerItemLayoutData rows="4" columns="4" />
                        </f:layoutData>
                        <f:header>
                            <card:Header title="Sustainability Impact" subtitle="CO₂ vs. Referenz" iconSrc="sap-icon://world" />
                        </f:header>
                        <f:content>
                            <VBox class="sapUiMediumMargin" height="100%" justifyContent="SpaceBetween" alignItems="Center">
                                <Title text="Gesamt-Einsparung" level="H4"/>
                                <mc:RadialMicroChart size="L" percentage="{dashboard>/stats/co2Target}" valueColor="Good" class="sapUiSmallMarginTopBottom"/>
                                <ObjectNumber number="{dashboard>/stats/co2Saved}" unit="kg CO₂" state="Success" class="sapMObjectNumberLarge" />
                            </VBox>
                        </f:content>
                    </f:Card>

                    <f:Card>
                        <f:layoutData>
                            <f:GridContainerItemLayoutData rows="4" columns="5" />
                        </f:layoutData>
                        <f:header>
                            <card:Header title="Flotten-Mix" subtitle="Antriebsarten" iconSrc="sap-icon://pie-chart" />
                        </f:header>
                        <f:content>
                            <FlexBox height="100%" width="100%" alignItems="Center" justifyContent="Center" class="sapUiMediumMargin">
                                <mc:InteractiveDonutChart selectionEnabled="true" segments="{dashboard>/fleetMix}">
                                    <mc:segments>
                                        <mc:InteractiveDonutChartSegment label="{dashboard>label}" value="{dashboard>value}" displayedValue="{dashboard>displayValue}" color="{dashboard>color}"/>
                                    </mc:segments>
                                </mc:InteractiveDonutChart>
                            </FlexBox>
                        </f:content>
                    </f:Card>

                     <f:Card>
                        <f:layoutData>
                            <f:GridContainerItemLayoutData rows="4" columns="3" />
                        </f:layoutData>
                        <f:header>
                            <card:Header title="Quick Links" subtitle="Favoriten" iconSrc="sap-icon://favorite" />
                        </f:header>
                        <f:content>
                            <List class="sapUiTinyMarginTop">
                                <StandardListItem title="Fahrzeug anlegen" icon="sap-icon://add" type="Active" info="Neu" infoState="Success"/>
                                <StandardListItem title="Fahrer kontaktieren" icon="sap-icon://call" type="Active" />
                                <StandardListItem title="Bericht exportieren" icon="sap-icon://excel-attachment" type="Active" />
                            </List>
                        </f:content>
                    </f:Card>

                </f:GridContainer>

                <f:Card width="100%">
                    <f:header>
                        <card:Header title="Aktuelle Bestellungen" subtitle="Letzte Updates (Live)" iconSrc="sap-icon://sales-order" />
                    </f:header>
                    <f:content>
                        <Table 
                            id="ordersTable" 
                            inset="false" 
                            items="{dashboard>/orders}"
                            growing="true" 
                            growingThreshold="5"
                            mode="SingleSelectMaster"
                            selectionChange="onPressOrder"
                            class="sapUiSmallMargin">
                            
                            <columns>
                                <Column width="5rem" hAlign="Center"><Text text="Status" /></Column>
                                <Column><Text text="Bestell Nr." /></Column>
                                <Column minScreenWidth="Tablet" demandPopin="true"><Text text="Kunde / Adresse" /></Column>
                                <Column minScreenWidth="Desktop" demandPopin="true"><Text text="Route" /></Column>
                                <Column hAlign="End"><Text text="Pos." /></Column>
                            </columns>
                            
                            <items>
                                <ColumnListItem vAlign="Middle" type="Navigation">
                                    <cells>
                                        <ObjectStatus 
                                            icon="{= ${dashboard>status} === 'Delivered' ? 'sap-icon://accept' : (${dashboard>status} === 'Shipped' ? 'sap-icon://shipping-status' : 'sap-icon://pending')}"
                                            state="{dashboard>statusState}"
                                        />
                                        <ObjectIdentifier title="{dashboard>orderNum}" text="{dashboard>id}"/>
                                        <VBox>
                                            <Title text="{dashboard>customer}" level="H6"/>
                                            <Text text="{dashboard>address}" class="sapUiTinyMarginTop"/>
                                        </VBox>
                                        <ObjectStatus text="{dashboard>route}" state="{= ${dashboard>route} === 'Nicht zugewiesen' ? 'Error' : 'None'}" />
                                        <ObjectNumber number="{dashboard>items}" />
                                    </cells>
                                </ColumnListItem>
                            </items>
                        </Table>
                    </f:content>
                </f:Card>

            </VBox>
        </f:content>
    </f:DynamicPage>
</mvc:View>